import ( "ModMenu.msg" );

// Used to hardcode overworld mod menu return points
int gLocation;

// Open menu
void ModMenuDisplay(int location)
{
	gLocation = location;
	OPEN_MSG_WIN();
	MSG( Welcome );
	SET_SEL_CHOICE_KEYBIND(6,20);
	int select = SEL( Mod_Menu );
	
	switch (select)
	{
		case 0:
			EventSelect();
			break;
		case 1:
			FieldSelect();
			break;
		case 2:
			BattleSelect();
			break;
		case 3:			
			BGMSelect();
			break;
		case 4:
			MovieSelect();
			break;
		case 5:
			DungeonSelect();
			break;
		case 6:
			ToggleBit();
			break;
		case 7:
			Facilities_Menu_Display();
			break;
		case 8:
			CLOSE_MSG_WIN();
			FastTravel();
			break;
		case 9:
			Save();
			break;
		case 20:
			break;
	}
	CLOSE_MSG_WIN();
}

void ToggleBit()
{
	int major = Get_Number(4, SelectFlag);
	if (major == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	int flag = BIT_CHK(major);
	int mask = 0;
	if (flag)
		mask = 1;
	else
		mask = 2;
	SET_MSG_VAR(0, major, 0);
	SET_MSG_VAR(1, flag, 0);
	MSG( CurrentFlag );
	SET_SEL_CHOICE_KEYBIND(6,3);
	SET_MASK(mask);
	int toggle = SEL(OnOff);
	if (toggle == 0)
	{
		BIT_ON(major);
	}
	else if (toggle == 1)
	{
		BIT_OFF(major);
	}
	else
	{
		CLOSE_MSG_WIN();
		return;
	}
	SET_MSG_VAR(0, major, 0);
	SET_MSG_VAR(1, BIT_CHK(major), 0);
    MSG( FlagConfirmation );
	CLOSE_MSG_WIN();
}

void Facilities_Menu_Display()
{
	SET_SEL_CHOICE_KEYBIND(6,20);
	int select = SEL( Facilities_Menu );
	CLOSE_MSG_WIN();
	switch (select)
	{
		case 0:
			VelvetRoom();
			break;
		case 1:
			Police();
			break;
		case 2:
			Pharmacy();
			break;
		case 3:
			Antique();
			break;
		case 4:
			Accessory();
			break;
		case 20:
			break;
	}
}

// Facility functions
void Accessory()
{
	int floor = GET_FLOOR_ID();
	CALL_SFX( 2, 8 );
	FLD_FUNCTION_0089( 10253, 0, 0, 0, 1 );
	FADE( 2, 0 );
	FADE_SYNC();
	BIT_ON( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
	FUNCTION_002A( 1 );
	FUNCTION_002B();
	BIT_OFF( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
	
	if (floor != 0) // return to current tartarus floor
		CALL_FLOOR( floor );
	else if (gLocation == 1)
		CALL_FIELD( 6, 3, 3, 0 ); // return to student with glasses
	else if (gLocation == 2)
		CALL_FIELD( 7, 2, 0, 0 ); // return to dorm entrance
	else if (gLocation == 3)
		CALL_FIELD( 4, 10, 8, 0 ); // return to dorm entrance (answer)
}

void Police()
{
	int floor = GET_FLOOR_ID();
	
	CALL_SFX( 2, 8 );
    FLD_FUNCTION_0089( 10252, 0, 0, 0, 1 );
    FADE( 2, 0 );
    FADE_SYNC();
	BIT_ON( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
    FUNCTION_002A( 0 );
    FUNCTION_002B();
    BIT_OFF( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
    CALL_FIELD( 8, 1, 6, 0 );
	
	if (floor != 0) // return to current tartarus floor
		CALL_FLOOR( floor );
	else if (gLocation == 1)
		CALL_FIELD( 6, 3, 3, 0 ); // return to student with glasses
	else if (gLocation == 2)
		CALL_FIELD( 7, 2, 0, 0 ); // return to dorm entrance
	else if (gLocation == 3)
		CALL_FIELD( 4, 10, 8, 0 ); // return to dorm entrance (answer)
}

void Antique()
{
	int floor = GET_FLOOR_ID();
	CALL_SFX( 2, 8 );
    FLD_FUNCTION_0089( 10250, 0, 0, 0, 1 );
    FADE( 2, 0 );
    FADE_SYNC();
    BIT_ON( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
    FUNCTION_002A( 4 );
    FUNCTION_002B();
    BIT_OFF( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
	if (floor != 0) // return to current tartarus floor
		CALL_FLOOR( floor );
	else if (gLocation == 1)
		CALL_FIELD( 6, 3, 3, 0 ); // return to student with glasses
	else if (gLocation == 2)
		CALL_FIELD( 7, 2, 0, 0 ); // return to dorm entrance
	else if (gLocation == 3)
		CALL_FIELD( 4, 10, 8, 0 ); // return to dorm entrance (answer)
}

void Pharmacy()
{
	int floor = GET_FLOOR_ID();
	CALL_SFX( 2, 8 );
	FLD_FUNCTION_0089( 10249, 0, 0, 0, 1 );
	FADE( 2, 0 );
	FADE_SYNC();
	BIT_ON( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
	FUNCTION_002A( 2 );
	FUNCTION_002B();
	BIT_OFF( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
	if (floor != 0) // return to current tartarus floor
		CALL_FLOOR( floor );
	else if (gLocation == 1)
		CALL_FIELD( 6, 3, 3, 0 ); // return to student with glasses
	else if (gLocation == 2)
		CALL_FIELD( 7, 2, 0, 0 ); // return to dorm entrance
	else if (gLocation == 3)
		CALL_FIELD( 4, 10, 8, 0 ); // return to dorm entrance (answer)
}

void VelvetRoom()
{
	if (gLocation == 1)
		BIT_ON(7001);
	else if (gLocation == 2)
		BIT_ON(7002);
	else if (gLocation == 3)
		BIT_ON(7003);
	else
		BIT_ON( 0 + 0x0400 + 0x0800 + 1 ); // return to tartarus entrance until I find get/set count functions
	CALL_SFX( 2, 0x20 );
	FLD_FUNCTION_0089( 10243, 1, 0, 0, 1 );
	FADE( 6, 30 );
	FADE_SYNC();
	CALL_FIELD( 8, 3, 0, 0 );
}

// Brings up fast travel map
void FastTravel()
{
	BIT_ON( 0 + 0x0400 + 0x0800 + 19 );
	FADE( 1, 0 );
	FADE_SYNC();
	TOWN_MAP( 0 );
}

// Save wherever you can call mod menu
// Seems to not save exact floor in tartarus but the first floor of the block
void Save()
{
	FADE( 5, 10 );
	FADE_SYNC();
	FUNCTION_018F();
	FUNCTION_0190();
	FUNCTION_000D( 0 );
	FADE_SYNC();
}

// Call functions
void BattleSelect()
{
	int floor = GET_FLOOR_ID();
	int major = Get_Number(3, SelectID3);
	if (major == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	CLOSE_MSG_WIN();
	CALL_SFX( 3, 0 );
	FUNCTION_01C2();
	FUNCTION_01C3();
	CALL_BATTLE( major );
	FADE( 3, 0 );
	FADE_SYNC();
	FUNCTION_00A6();
	FUNCTION_01E7();
	FUNCTION_01A5();
	if (floor != 0) // return to current tartarus floor
		CALL_FLOOR( floor );
	else if (gLocation == 1)
		CALL_FIELD( 6, 3, 3, 0 ); // return to student with glasses
	else if (gLocation == 2)
		CALL_FIELD( 7, 2, 0, 0 ); // return to dorm entrance
	else if (gLocation == 3)
		CALL_FIELD( 4, 10, 8, 0 ); // return to dorm entrance (answer)
}

// Call floor
void DungeonSelect()
{
	int major = Get_Number(3, SelectFloor);
	if (major == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	CLOSE_MSG_WIN();
	FADE( 3, 0 );
	FADE_SYNC();
	CALL_FLOOR( major );
}

void MovieSelect()
{
	int floor = GET_FLOOR_ID();
	int major = Get_Number(2, SelectID2);
	if (major == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	CLOSE_MSG_WIN();
	// silence
	CALL_BGM(999);
	CALL_MOVIE(major);
	NS_MOVIE_SYNC();
	FADE( 3, 0 );
	FADE_SYNC();
	if (floor != 0)
		CALL_FLOOR( floor );
	else if (gLocation == 1)
		CALL_FIELD( 6, 3, 3, 0 );
	else if (gLocation == 2)
		CALL_FIELD( 7, 2, 0, 0 );
	else if (gLocation == 3)
		CALL_FIELD( 4, 10, 8, 0 ); // return to dorm entrance (answer)
}

void EventSelect()
{
	int floor = GET_FLOOR_ID();
	int major = Get_Number(3, SelectMajor);
	if (major == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	int minor = Get_Number(3, SelectMinor);
	if (minor == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	CLOSE_MSG_WIN();
	FADE( 3, 0 );
	FADE_SYNC();
	BIT_ON( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
	CALL_EVENT( major, minor, 0);
	FADE( 3, 0 );
	FADE_SYNC();
	if (floor != 0)
		CALL_FLOOR( floor );
	else if (gLocation == 1)
		CALL_FIELD( 6, 3, 3, 0 );
	else if (gLocation == 2)
		CALL_FIELD( 7, 2, 0, 0 );
	else if (gLocation == 3)
		CALL_FIELD( 4, 10, 8, 0 ); // return to dorm entrance (answer)
}

void FieldSelect()
{
	int major = Get_Number(3, SelectMajor);
	if (major == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	int minor = Get_Number(3, SelectMinor);
	if (minor == -1)
	{
		CLOSE_MSG_WIN();
		return;
	}
	int pos = Get_Number(2, SelectPosition);
	FADE( 3, 0 );
	FADE_SYNC();
	BIT_ON( 0 + 0x0400 + 0x0800 + 0x0400 + 0x0400 + 7 );
	CALL_FIELD( major, minor, pos, 0 );
}

void BGMSelect()
{
	int major = Get_Number(3, SelectID3);
	CLOSE_MSG_WIN();
	CALL_BGM(major);
}

// Used for getting id's for calling functions
int Get_Number(int digitNum, int helpText)
{
	tryagain:
	MSG( helpText );
	int digit = 0;
	int n = 0;
	_OpenNumMenu:
	while (n < digitNum)
	{
		SET_SEL_CHOICE_KEYBIND(6, 20);
		int select = SEL( Num_Menu );
		if (select == 20)
			return -1;
		digit *= 10;
		digit += select;
		n += 1;
	}
	
	// Confirmation
	SET_MSG_VAR(0, digit, 0);
    MSG( Confirmation );
	SET_SEL_CHOICE_KEYBIND(6,1);
	if (SEL(YesNo) == 1)
		goto tryagain;
	
	return(digit);
}